<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Previous head content remains the same -->
  <!-- ... -->
</head>
<body>
  <!-- Previous HTML content remains the same -->
  <!-- ... -->

  <script>
    Backendless.initApp({
      appId: "3E6C2C39-6779-4034-B008-C3043326DE7A",
      apiKey: "ACFC4906-9EF5-4356-9F9D-42B8D7397E0B"
    });

    // Pagination variables
    let currentPage = 1;
    const transactionsPerPage = 10;
    let totalTransactions = 0;
    let totalPages = 1;
    let allTransactions = [];
    let calculatedTotals = {
      totalAdded: 0,
      totalSpent: 0,
      spentCategories: {},
      monthlyData: {}
    };

    async function loadOverview() {
      try {
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get("roomId");
        if (!roomId) {
          window.location.href = "main.html";
          return;
        }

        const currentUser = await Backendless.UserService.getCurrentUser();
        if (!currentUser) {
          window.location.href = "index.html";
          return;
        }

        const room = await Backendless.Data.of("Rooms").findById(roomId);
        if (!room) {
          window.location.href = "main.html";
          return;
        }

        // Update room info badges
        document.getElementById("roomNameBadge").innerHTML = `
          <i class="fas fa-door-closed"></i>
          <span>${room.roomName}</span>
        `;
        document.getElementById("roomCodeBadge").innerHTML = `
          <i class="fas fa-key"></i>
          <span>Code: ${room.roomCode}</span>
        `;

        // Check admin role
        const memberQuery = Backendless.DataQueryBuilder.create()
          .setWhereClause(`roomCode = '${room.roomCode}' AND userId = '${currentUser.objectId}'`);
        const members = await Backendless.Data.of("Members").find(memberQuery);
        const isAdmin = members.length && members[0].role === "admin";

        // Render sidebar
        document.querySelector(".sidebar-nav").innerHTML = `
          <a href="room_dashboard.html?roomId=${roomId}"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a>
          ${isAdmin ? `<a href="add_money.html?roomId=${roomId}"><i class="fas fa-plus-circle"></i> <span>Add Money</span></a>` : ''}
          ${isAdmin ? `<a href="spent_money.html?roomId=${roomId}"><i class="fas fa-minus-circle"></i> <span>Spent Money</span></a>` : ''}
          <a href="transactions.html?roomId=${roomId}"><i class="fas fa-exchange-alt"></i> <span>Transactions</span></a>
          <a href="overview.html?roomId=${roomId}" class="active"><i class="fas fa-chart-pie"></i> <span>Overview</span></a>
          <a href="download_pdf.html?roomId=${roomId}"><i class="fas fa-file-pdf"></i> <span>Download PDF</span></a>
        `;

        // First, calculate totals from ALL transactions
        await calculateTotals(room.roomCode);
        
        // Then load transactions for display (with pagination)
        await loadTransactionsForDisplay(room.roomCode);
        
        // Display first page of transactions
        displayTransactions(currentPage);

        // Update the UI with calculated totals
        const balance = calculatedTotals.totalAdded - calculatedTotals.totalSpent;
        document.getElementById("totalAdded").textContent = "₹" + calculatedTotals.totalAdded.toFixed(2);
        document.getElementById("totalSpent").textContent = "₹" + calculatedTotals.totalSpent.toFixed(2);
        document.getElementById("balance").textContent = "₹" + balance.toFixed(2);

        // Create Pie Chart (Spending by Category)
        const pieCtx = document.getElementById("pieChart").getContext("2d");
        new Chart(pieCtx, {
          type: "doughnut",
          data: {
            labels: Object.keys(calculatedTotals.spentCategories),
            datasets: [{
              data: Object.values(calculatedTotals.spentCategories),
              backgroundColor: [
                "#ef4444", "#f97316", "#eab308", "#10b981",
                "#3b82f6", "#8b5cf6", "#ec4899", "#14b8a6",
                "#f43f5e", "#84cc16", "#0ea5e9"
              ],
              borderWidth: 0,
              borderRadius: 6
            }]
          },
          options: {
            cutout: '70%',
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  color: "#fff",
                  padding: 20,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 12 },
                padding: 12,
                cornerRadius: 8,
                displayColors: true,
                usePointStyle: true,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const percentage = Math.round((value / calculatedTotals.totalSpent) * 100);
                    return `${label}: ₹${value.toFixed(2)} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        // Create Bar Chart (Monthly Spending Trend)
        const barCtx = document.getElementById("barChart").getContext("2d");
        new Chart(barCtx, {
          type: "bar",
          data: {
            labels: Object.keys(calculatedTotals.monthlyData),
            datasets: [{
              label: "Monthly Spend (₹)",
              data: Object.values(calculatedTotals.monthlyData),
              backgroundColor: "#3b82f6",
              borderRadius: 6,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: "#94a3b8" }
              },
              y: {
                grid: { color: "rgba(255,255,255,0.1)" },
                ticks: { color: "#94a3b8" }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 12 },
                padding: 12,
                cornerRadius: 8
              }
            }
          }
        });

        // Populate Category Breakdown Table
        const categoryBody = document.querySelector("#categoryTable tbody");
        Object.entries(calculatedTotals.spentCategories).forEach(([cat, amt]) => {
          const percentage = calculatedTotals.totalSpent > 0 ? Math.round((amt / calculatedTotals.totalSpent) * 100) : 0;
          const row = `<tr>
            <td>${cat}</td>
            <td><strong>₹${amt.toFixed(2)}</strong></td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span>${percentage}%</span>
                <div style="flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                  <div style="width: ${percentage}%; height: 100%; background: var(--primary); border-radius: 3px;"></div>
                </div>
              </div>
            </td>
          </tr>`;
          categoryBody.insertAdjacentHTML("beforeend", row);
        });

      } catch (err) {
        console.error("Error loading overview:", err);
      }
    }

    async function calculateTotals(roomCode) {
      try {
        // Reset totals
        calculatedTotals = {
          totalAdded: 0,
          totalSpent: 0,
          spentCategories: {},
          monthlyData: {}
        };

        // Query to get all transactions for calculations
        const queryBuilder = Backendless.DataQueryBuilder.create()
          .setWhereClause(`roomCode = '${roomCode}'`)
          .setSortBy(["created desc"]);

        // First get the count of all transactions
        const count = await Backendless.Data.of("Transactions").getObjectCount(queryBuilder);
        
        // Set page size to maximum (100 is Backendless max)
        queryBuilder.setPageSize(100);
        
        // Calculate how many pages we need to load
        const totalPages = Math.ceil(count / 100);
        
        // Load all pages and calculate totals
        for (let page = 1; page <= totalPages; page++) {
          queryBuilder.setOffset((page - 1) * 100);
          const transactions = await Backendless.Data.of("Transactions").find(queryBuilder);
          
          transactions.forEach(t => {
            if (t.type === "add") {
              calculatedTotals.totalAdded += t.amount;
            } else if (t.type === "spent") {
              calculatedTotals.totalSpent += t.amount;
              calculatedTotals.spentCategories[t.category] = 
                (calculatedTotals.spentCategories[t.category] || 0) + t.amount;

              const month = new Date(t.created).toLocaleString('default', { month: 'short', year: 'numeric' });
              calculatedTotals.monthlyData[month] = 
                (calculatedTotals.monthlyData[month] || 0) + t.amount;
            }
          });
        }
      } catch (err) {
        console.error("Error calculating totals:", err);
      }
    }

    async function loadTransactionsForDisplay(roomCode) {
      try {
        const query = Backendless.DataQueryBuilder.create()
          .setWhereClause(`roomCode = '${roomCode}'`)
          .setSortBy(["created desc"])
          .setPageSize(transactionsPerPage);
        
        const result = await Backendless.Data.of("Transactions").find(query);
        allTransactions = result.data;
        totalTransactions = result.totalObjects;
        totalPages = Math.ceil(totalTransactions / transactionsPerPage);
        
        // Update pagination controls
        updatePaginationControls();
      } catch (err) {
        console.error("Error loading transactions for display:", err);
      }
    }

    async function loadMoreTransactions(page) {
      try {
        const query = Backendless.DataQueryBuilder.create()
          .setWhereClause(`roomCode = '${allTransactions[0].roomCode}'`)
          .setSortBy(["created desc"])
          .setPageSize(transactionsPerPage)
          .setOffset((page - 1) * transactionsPerPage);
        
        const result = await Backendless.Data.of("Transactions").find(query);
        allTransactions = result.data;
        displayTransactions(page);
      } catch (err) {
        console.error("Error loading more transactions:", err);
      }
    }

    function displayTransactions(page) {
      const transactionsBody = document.querySelector("#transactionsTable tbody");
      transactionsBody.innerHTML = '';
      
      allTransactions.forEach(t => {
        const date = new Date(t.created).toLocaleDateString();
        const typeBadge = t.type === "add"
          ? '<span class="badge badge-add"><i class="fas fa-plus-circle"></i> Add</span>'
          : '<span class="badge badge-spent"><i class="fas fa-minus-circle"></i> Spent</span>';

        const description = t.type === "add" 
          ? `Added via ${t.paidType || 'unknown'}`
          : `Spent on ${t.category || 'unknown'}`;

        const row = `<tr>
          <td>${date}</td>
          <td>${typeBadge}</td>
          <td>${description}</td>
          <td><strong>₹${t.amount.toFixed(2)}</strong></td>
        </tr>`;
        transactionsBody.insertAdjacentHTML("beforeend", row);
      });
      
      // Update page info
      document.getElementById("pageInfo").textContent = `Page ${page} of ${totalPages}`;
    }

    function updatePaginationControls() {
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPages;
    }

    // Event listeners for pagination
    document.getElementById("prevPage").addEventListener("click", async () => {
      if (currentPage > 1) {
        currentPage--;
        await loadMoreTransactions(currentPage);
        updatePaginationControls();
      }
    });

    document.getElementById("nextPage").addEventListener("click", async () => {
      if (currentPage < totalPages) {
        currentPage++;
        await loadMoreTransactions(currentPage);
        updatePaginationControls();
      }
    });

    window.onload = loadOverview;
  </script>
</body>
</html>
